<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Remote Power • MASTER</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
 :root{--bg:#0f172a;--fg:#e2e8f0;--muted:#94a3b8;--card:#111827;--btn:#1f2937}
 html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);
           font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
 header{display:flex;justify-content:space-between;align-items:center;
        padding:16px 20px;border-bottom:1px solid #243045}
 h1{font-size:18px;margin:0}
 .row{display:flex;gap:10px;align-items:center}
 button{background:var(--btn);border:1px solid #2b364c;border-radius:8px;
        color:var(--fg);padding:8px 12px;cursor:pointer}
 button:hover{filter:brightness(1.08)}
 .primary{background:#2563eb;border-color:#1d4ed8}
 .danger{background:#7f1d1d;border-color:#991b1b}
 .muted{color:var(--muted)}
 main{max-width:980px;margin:24px auto;padding:0 16px}
 .card{background:var(--card);border:1px solid #243045;border-radius:12px;padding:14px}
 .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
 .dev{display:flex;flex-direction:column;gap:8px}
 .head{display:flex;justify-content:space-between;gap:8px;align-items:center}
 .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #243045}
 .on{background:#0b3b2e;color:#86efac;border-color:#14532d}
 .off{background:#3b1a1a;color:#fecaca;border-color:#7f1d1d}
 .meta,.slaves{font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:2px}
 .actions{display:flex;flex-wrap:wrap;gap:6px}
 .chip{display:inline-flex;align-items:center;gap:6px;background:#334155;border-radius:999px;padding:2px 8px;margin:1px}
 .chip .mac{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px}
 .chip .mini{display:flex;gap:6px}
 .log{white-space:pre-wrap;background:#0b1220;border:1px solid #243045;border-radius:10px;
      padding:10px;height:160px;overflow:auto}
 dialog{border:1px solid #243045;border-radius:12px;background:var(--card);
        color:var(--fg);padding:0;max-width:420px}
 dialog .dlg{padding:16px;display:flex;flex-direction:column;gap:10px}
 code{background:#0b1220;border:1px solid #243045;border-radius:6px;padding:2px 6px}
 .cmds{margin:6px 0 0;padding-left:18px;font-size:12px}
 .sep{height:1px;background:#243045;margin:8px 0}
 .right{margin-left:auto}
 .tiny{font-size:11px;padding:3px 6px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>

<body>
<header>
  <h1>Remote Power • MASTER</h1>
  <div class="row">
    <span id="userEmail" class="muted">non connecté</span>
    <button id="btnLogin"  class="primary" type="button" onclick="onLogin()">Connexion Google</button>
    <button id="btnLogout" type="button" style="display:none" onclick="onLogout()">Déconnexion</button>
  </div>
</header>

<main>
  <div class="row" style="justify-content:space-between;margin-bottom:12px">
    <div class="muted">Compte : <span id="who">—</span></div>
    <div class="row">
      <button id="btnAdd" class="primary" type="button" onclick="onAdd()">Ajouter un MASTER</button>
      <button id="btnRefresh" type="button" onclick="loadAll()">Rafraîchir</button>
    </div>
  </div>
  <div id="devices" class="grid"></div>
  <h3>Journal</h3><div id="log" class="log"></div>
</main>

<!-- Dialogue pair-code -->
<dialog id="dlgPair"><div class="dlg">
  <h3>Appairer un MASTER</h3>
  <div>Code : <code id="pairCode">······</code>
       (expire <span id="pairExpires" class="muted"></span>)</div>
  <div class="muted">Saisis ce code dans le portail Wi-Fi de l’ESP32.</div>
  <div class="row" style="justify-content:flex-end">
    <button onclick="dlgPair.close()">Fermer</button>
  </div>
</div></dialog>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL = "https://zeknluovgbsmtgupwkvo.supabase.co";
const SUPA_ANON    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpla25sdW92Z2JzbXRndXB3a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MjY2NjIsImV4cCI6MjA3NDMwMjY2Mn0.AjCTWEAGBBhi5liJv8LBCK_baqivRlDIYMbFcDeA_q4";

/* ---------- PARAMS UI ---------- */
const DEFAULT_IO_PIN = 26;        // pin par défaut pour SLV_IO
const LIVE_TTL_MS    = 25_000;    // fenêtre "en ligne"

/* ---------- INIT ---------- */
const sb   = window.supabase.createClient(SUPABASE_URL, SUPA_ANON);
const $    = id => document.getElementById(id);
const log  = t => { const L=$('log'); L.textContent += new Date().toLocaleTimeString()+"  "+t+"\n"; L.scrollTop=L.scrollHeight; };

/* ---------- État ---------- */
let devices = [];                       // masters (array)
let nodesByMaster = {};                 // { master_id : [ slave_mac, ... ] }
const cards = new Map();                // master_id -> DOM elements bundle
let chDevices, chNodes, chCmds;

/* ---------- Helpers ---------- */
const isLive = d => d.last_seen && (Date.now()-new Date(d.last_seen) < LIVE_TTL_MS);
const fmtTS  = s => s ? new Date(s).toLocaleString() : "—";

/* ---------- Auth ---------- */
function updateAuth(u){
  $("userEmail").textContent = u ? u.email : "non connecté";
  $("btnLogin").style.display = u ? "none":"inline-block";
  $("btnLogout").style.display= u ? "inline-block":"none";
  $("who").textContent = u ? u.email : "—";
}
async function onLogin(){
  const {data,error} = await sb.auth.signInWithOAuth({
    provider:"google",
    options:{redirectTo:location.href, queryParams:{prompt:"select_account"}, skipBrowserRedirect:true}
  });
  if(error) alert(error.message); else if(data?.url) location.href=data.url;
}
function onLogout(){ sb.auth.signOut(); }

/* ---------- Chargement complet ---------- */
async function loadAll(){
  /* masters */
  const {data:devs,error:ed} = await sb
    .from('devices')
    .select('id,name,master_mac,last_seen,online')
    .order('created_at',{ascending:false});
  if(ed){ log("Err devices: "+ed.message); return; }
  devices = devs || [];

  /* slaves */
  const {data:nodes,error:en} = await sb
    .from('nodes')
    .select('master_id,slave_mac');
  if(en){ log("Err nodes: "+en.message); return; }
  nodesByMaster = {};
  (nodes||[]).forEach(n => {
    (nodesByMaster[n.master_id] ??= []).push(n.slave_mac);
  });

  renderAll();
  for (const d of devices) await refreshCommands(d.id);
}

/* ---------- Commandes ---------- */
async function sendCmd(masterId, targetMac, action, payload={}){
  const {error} = await sb.from('commands').insert({
    master_id : masterId,
    target_mac: targetMac || null,
    action,
    payload
  });
  if(error) log("cmd err: "+error.message);
  else log(`[cmd] ${action} → ${masterId}${targetMac?" ▶ "+targetMac:""}`);
}

/* ---- Master: renommer & supprimer ---- */
async function renameMaster(id){
  const name = prompt("Nouveau nom pour le master ?", "");
  if(!name) return;
  const { error } = await sb.from('devices').update({ name }).eq('id', id);
  if(error) alert(error.message);
  else log(`Renommé ${id} → ${name}`);
}
async function deleteDevice(id){
  if(!confirm(`Supprimer ${id} ?`)) return;
  const {data:{session}} = await sb.auth.getSession();
  if(!session){alert("Non connecté"); return;}
  const r = await fetch(`${SUPABASE_URL}/functions/v1/release_and_delete`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      apikey:SUPA_ANON,
      Authorization:`Bearer ${session.access_token}`
    },
    body:JSON.stringify({ master_id:id })
  });
  log(r.ok ? `MASTER supprimé : ${id}` : `❌ Suppression : ${await r.text()}`);
}

/* ---------- Rendu : créer/MAJ une carte ---------- */
function renderAll(){
  const root=$("devices"); root.innerHTML="";
  cards.clear();
  if(!devices.length){ root.textContent="Aucun MASTER."; return; }

  devices.forEach(d=>{
    const live = isLive(d);
    const card = document.createElement("div"); card.className="card dev";
    card.innerHTML = `
      <div class="head">
        <div class="title">${d.name||d.id}</div>
        <span class="badge ${live?'on':'off'}">${live?'En ligne':'Hors ligne'}</span>
      </div>
      <div class="meta">
        ID : <span class="id">${d.id}</span><br>
        MAC : <span class="mac">${d.master_mac||'—'}</span><br>
        Dernier contact : <span class="last">${fmtTS(d.last_seen) || 'jamais'}</span>
      </div>
      <div class="slaves"></div>
      <div class="actions"></div>
      <div class="sep"></div>
      <div class="muted" style="font-size:12px">Commandes (20 dernières)</div>
      <ul class="cmds"></ul>
    `;

    // Slaves chips + boutons
    const slavesDiv = card.querySelector(".slaves");
    const slaves = nodesByMaster[d.id] || [];
    if (slaves.length){
      slavesDiv.textContent = "Slaves : ";
      slaves.forEach(mac=>{
        const chip=document.createElement("span"); chip.className="chip";
        const label=document.createElement("span"); label.className="mac"; label.textContent=mac;
        const mini = document.createElement("span"); mini.className="mini";
        const mk=(txt,cb)=>{const b=document.createElement("button"); b.textContent=txt; b.className="tiny"; b.onclick=cb; return b;};
        // IO ON / OFF (pin par défaut)
        mini.appendChild(mk("IO ON",  ()=>sendCmd(d.id, mac, "SLV_IO",        { pin: DEFAULT_IO_PIN, mode:"OUT", value:1 })));
        mini.appendChild(mk("IO OFF", ()=>sendCmd(d.id, mac, "SLV_IO",        { pin: DEFAULT_IO_PIN, mode:"OUT", value:0 })));
        // Reset / Force off / Hard reset
        mini.appendChild(mk("Reset",      ()=>sendCmd(d.id, mac, "SLV_RESET",     {})));
        mini.appendChild(mk("Force OFF",  ()=>sendCmd(d.id, mac, "SLV_FORCE_OFF", {})));
        mini.appendChild(mk("Hard 3s",    ()=>sendCmd(d.id, mac, "SLV_HARD_RESET",{ ms:3000 })));

        chip.append(label, mini);
        slavesDiv.appendChild(chip);
      });
    } else {
      slavesDiv.textContent = "Aucun slave.";
    }

    // Actions master
    const act=card.querySelector(".actions");
    const addBtn=(txt,cls,cb)=>{const b=document.createElement("button"); b.textContent=txt; if(cls) b.className=cls; b.onclick=cb; act.appendChild(b);};
    addBtn("Renommer","",      ()=>renameMaster(d.id));
    addBtn("Pulse 500 ms","",  ()=>sendCmd(d.id,null,"PULSE",{ms:500}));
    addBtn("Power ON","",      ()=>sendCmd(d.id,null,"POWER_ON"));
    addBtn("Power OFF","",     ()=>sendCmd(d.id,null,"POWER_OFF"));
    addBtn("Reset","",         ()=>sendCmd(d.id,null,"RESET"));
    const del=document.createElement("button"); del.textContent="Supprimer"; del.className="danger right"; del.onclick=()=>deleteDevice(d.id); act.appendChild(del);

    // Ajoute la carte
    $("devices").appendChild(card);

    // Enregistre les hooks DOM pour MAJ ciblées
    cards.set(d.id, {
      card,
      badge: card.querySelector(".badge"),
      title: card.querySelector(".title"),
      metaId: card.querySelector(".id"),
      metaMac: card.querySelector(".mac"),
      metaLast: card.querySelector(".last"),
      slavesDiv,
      cmdsEl: card.querySelector(".cmds"),
    });
  });
}

/* --- met à jour seulement les éléments de la carte concernée --- */
function patchDeviceRow(dev){
  const ref = cards.get(dev.id);
  if(!ref) return;
  const live = isLive(dev);
  ref.badge.textContent = live ? "En ligne" : "Hors ligne";
  ref.badge.className = `badge ${live?'on':'off'}`;
  if (dev.name) ref.title.textContent = dev.name;
  if (dev.master_mac) ref.metaMac.textContent = dev.master_mac;
  if (dev.last_seen) ref.metaLast.textContent = fmtTS(dev.last_seen);
}

/* --- recharge la liste des slaves pour un master --- */
function refreshSlavesFor(masterId){
  const ref = cards.get(masterId);
  if(!ref) return;
  sb.from('nodes').select('slave_mac').eq('master_id', masterId).then(({data})=>{
    nodesByMaster[masterId] = (data||[]).map(x=>x.slave_mac);
    const d = nodesByMaster[masterId];
    ref.slavesDiv.innerHTML = "";
    if (d && d.length){
      ref.slavesDiv.textContent="Slaves : ";
      d.forEach(mac=>{
        const chip=document.createElement("span"); chip.className="chip";
        const label=document.createElement("span"); label.className="mac"; label.textContent=mac;
        const mini = document.createElement("span"); mini.className="mini";
        const mk=(txt,cb)=>{const b=document.createElement("button"); b.textContent=txt; b.className="tiny"; b.onclick=cb; return b;};
        mini.appendChild(mk("IO ON",  ()=>sendCmd(masterId, mac, "SLV_IO",        { pin: DEFAULT_IO_PIN, mode:"OUT", value:1 })));
        mini.appendChild(mk("IO OFF", ()=>sendCmd(masterId, mac, "SLV_IO",        { pin: DEFAULT_IO_PIN, mode:"OUT", value:0 })));
        mini.appendChild(mk("Reset",      ()=>sendCmd(masterId, mac, "SLV_RESET",     {})));
        mini.appendChild(mk("Force OFF",  ()=>sendCmd(masterId, mac, "SLV_FORCE_OFF", {})));
        mini.appendChild(mk("Hard 3s",    ()=>sendCmd(masterId, mac, "SLV_HARD_RESET",{ ms:3000 })));
        chip.append(label, mini);
        ref.slavesDiv.appendChild(chip);
      });
    } else {
      ref.slavesDiv.textContent="Aucun slave.";
    }
  });
}

/* --- charge les 20 dernières commandes d’un master et les rend --- */
async function refreshCommands(masterId){
  const ref = cards.get(masterId); if(!ref) return;
  const { data, error } = await sb
    .from('commands')
    .select('id, action, target_mac, status, created_at')
    .eq('master_id', masterId)
    .order('created_at',{ascending:false})
    .limit(20);
  if(error){ log("Err cmds: "+error.message); return; }
  ref.cmdsEl.innerHTML = "";
  (data||[]).forEach(c => ref.cmdsEl.appendChild(renderCmdLi(c)));
}

/* --- ajoute/MAJ une ligne de commande --- */
function renderCmdLi(c){
  const li = document.createElement('li');
  li.id = `cmd-${c.id}`;
  li.innerHTML = `<code>${c.status}</code> · ${c.action}${c.target_mac ? ' → '+c.target_mac : ' (local)'} <span class="muted">· ${fmtTS(c.created_at)}</span>`;
  return li;
}
function upsertCmdRow(masterId, c){
  const ref = cards.get(masterId); if(!ref) return;
  const id = `cmd-${c.id}`;
  let li = ref.cmdsEl.querySelector(`#${CSS.escape(id)}`);
  if (!li){
    li = renderCmdLi(c);
    ref.cmdsEl.prepend(li);
    while (ref.cmdsEl.children.length > 20) ref.cmdsEl.removeChild(ref.cmdsEl.lastChild);
  } else {
    li.innerHTML = `<code>${c.status}</code> · ${c.action}${c.target_mac ? ' → '+c.target_mac : ' (local)'} <span class="muted">· ${fmtTS(c.created_at)}</span>`;
  }
}

/* ---------- Realtime (3 canaux) ---------- */
function attachRealtime(){
  if (chDevices) sb.removeChannel(chDevices);
  if (chNodes)   sb.removeChannel(chNodes);
  if (chCmds)    sb.removeChannel(chCmds);

  chDevices = sb.channel("rt:devices")
    .on('postgres_changes',{ event:'INSERT', schema:'public', table:'devices' }, (p)=>{
      log(`+ device ${p.new.id}`);
      devices.unshift(p.new);
      renderAll();
      refreshCommands(p.new.id);
    })
    .on('postgres_changes',{ event:'UPDATE', schema:'public', table:'devices' }, (p)=>{
      const d = p.new;
      const idx = devices.findIndex(x=>x.id===d.id);
      if (idx>=0) devices[idx] = { ...devices[idx], ...d };
      patchDeviceRow(d);
    })
    .on('postgres_changes',{ event:'DELETE', schema:'public', table:'devices' }, (p)=>{
      const id = p.old.id;
      log(`- device ${id}`);
      devices = devices.filter(x=>x.id!==id);
      renderAll();
    })
    .subscribe((s)=>{ if(s==='SUBSCRIBED') log('Realtime devices ON'); });

  chNodes = sb.channel("rt:nodes")
    .on('postgres_changes',{ event:'INSERT', schema:'public', table:'nodes' }, (p)=>{
      const m = p.new.master_id;
      log(`+ node ${p.new.slave_mac} → ${m}`);
      refreshSlavesFor(m);
    })
    .on('postgres_changes',{ event:'DELETE', schema:'public', table:'nodes' }, (p)=>{
      const m = p.old.master_id;
      log(`- node ${p.old.slave_mac} ← ${m}`);
      refreshSlavesFor(m);
    })
    .subscribe((s)=>{ if(s==='SUBSCRIBED') log('Realtime nodes ON'); });

  chCmds = sb.channel("rt:commands")
    .on('postgres_changes',{ event:'INSERT', schema:'public', table:'commands' }, (p)=>{
      const m = p.new.master_id;
      upsertCmdRow(m, p.new);
      log(`cmd + ${p.new.action} (${p.new.status}) → ${m}`);
    })
    .on('postgres_changes',{ event:'UPDATE', schema:'public', table:'commands' }, (p)=>{
      const m = p.new.master_id;
      upsertCmdRow(m, p.new);
      log(`cmd ~ ${p.new.action} (${p.new.status}) → ${m}`);
    })
    .subscribe((s)=>{ if(s==='SUBSCRIBED') log('Realtime commands ON'); });
}

/* ---------- Pair-code ---------- */
async function onAdd(){
  const {data:{session}} = await sb.auth.getSession();
  if(!session){alert("Non connecté");return;}
  try{
    const r=await fetch(`${SUPABASE_URL}/functions/v1/create_pair_code`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        apikey:SUPA_ANON,
        Authorization:`Bearer ${session.access_token}`
      },
      body:JSON.stringify({ ttl_minutes:10 })
    });
    if(!r.ok){alert(await r.text());return;}
    const {code,expires_at}=await r.json();
    $("pairCode").textContent=String(code).padStart(6,"0");
    const end=new Date(expires_at).getTime();
    const tick=()=>{ const l=Math.max(0,Math.floor((end-Date.now())/1000));
      $("pairExpires").textContent=`${Math.floor(l/60)}:${String(l%60).padStart(2,'0')}`;
      if(l<=0) clearInterval(intv);
    };
    tick(); const intv=setInterval(tick,1000);
    $("dlgPair").showModal();
    log(`Pair-code ${code}`);
  }catch(e){log("Erreur pair-code: "+e);}
}

/* ---------- Boot ---------- */
sb.auth.onAuthStateChange((ev,session)=>{
  if(ev==="INITIAL_SESSION" || ev==="SIGNED_IN" || ev==="SIGNED_OUT"){
    updateAuth(session?.user||null);
    if(session?.user){ attachRealtime(); loadAll(); }
    else {
      $("devices").innerHTML=""; cards.clear();
      if (chDevices) sb.removeChannel(chDevices);
      if (chNodes)   sb.removeChannel(chNodes);
      if (chCmds)    sb.removeChannel(chCmds);
      log("Déconnecté");
    }
  }
});
log("UI prête");
</script>
</body>
</html>
