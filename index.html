<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Remote Power • MASTER</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0f172a;--fg:#e2e8f0;--muted:#94a3b8;--card:#111827;--btn:#1f2937}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #243045}
    h1{font-size:18px;margin:0}
    .row{display:flex;gap:10px;align-items:center}
    button{background:var(--btn);border:1px solid #2b364c;border-radius:8px;color:var(--fg);padding:8px 12px;cursor:pointer}
    button:hover{filter:brightness(1.08)}
    .primary{background:#2563eb;border-color:#1d4ed8}
    .danger{background:#7f1d1d;border-color:#991b1b}
    .muted{color:var(--muted)}
    main{max-width:980px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #243045;border-radius:12px;padding:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .dev{display:flex;flex-direction:column;gap:8px}
    .head{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #243045}
    .on{background:#0b3b2e;color:#86efac;border-color:#14532d}
    .off{background:#3b1a1a;color:#fecaca;border-color:#7f1d1d}
    .meta{font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:2px}
    .actions{display:flex;flex-wrap:wrap;gap:6px}
    .log{white-space:pre-wrap;background:#0b1220;border:1px solid #243045;border-radius:10px;padding:10px;height:120px;overflow:auto}
    dialog{border:1px solid #243045;border-radius:12px;background:var(--card);color:var(--fg);padding:0;max-width:420px}
    dialog .dlg{padding:16px;display:flex;flex-direction:column;gap:10px}
    code{background:#0b1220;border:1px solid #243045;border-radius:6px;padding:2px 6px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>

<body>
<header>
  <h1>Remote Power • MASTER</h1>
  <div class="row">
    <span id="userEmail" class="muted">non connecté</span>
    <button id="btnLogin"  class="primary" type="button" onclick="onLogin()">Connexion Google</button>
    <button id="btnLogout" type="button" style="display:none" onclick="onLogout()">Déconnexion</button>
  </div>
</header>

<main>
  <div class="row" style="justify-content:space-between;margin-bottom:12px">
    <div class="muted">Compte : <span id="who">—</span></div>
    <div class="row">
      <button id="btnAdd" class="primary" type="button" onclick="onAdd()">Ajouter un MASTER</button>
      <button id="btnRefresh" type="button" onclick="loadDevices()">Rafraîchir</button>
    </div>
  </div>
  <div id="devices" class="grid"></div>
  <h3>Journal</h3><div id="log" class="log"></div>
</main>

<dialog id="dlgPair">
  <div class="dlg">
    <h3>Appairer un MASTER</h3>
    <div>Code : <code id="pairCode">······</code> (expire <span id="pairExpires" class="muted"></span>)</div>
    <div class="muted">Saisis ce code dans le portail Wi-Fi de l’ESP32.</div>
    <div class="row" style="justify-content:flex-end"><button onclick="dlgPair.close()">Fermer</button></div>
  </div>
</dialog>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL = "https://zeknluovgbsmtgupwkvo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpla25sdW92Z2JzbXRndXB3a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MjY2NjIsImV4cCI6MjA3NDMwMjY2Mn0.AjCTWEAGBBhi5liJv8LBCK_baqivRlDIYMbFcDeA_q4";

/* ---------- INIT ---------- */
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- DOM refs ---------- */
const $ = id => document.getElementById(id);
const devicesEl = $("devices");

/* ---------- Utils ---------- */
const log = m => { $('log').textContent += new Date().toLocaleTimeString()+"  "+m+"\n"; };
const isLive = d => d.last_seen && Date.now() - new Date(d.last_seen).getTime() < 25_000;
const pad6  = n => String(n).padStart(6,"0");

/* ---------- Global ---------- */
let devices = [];
let sub = null, tick = null;

/* ---------- Auth ---------- */
function updateAuthUI(user){
  $("userEmail").textContent = user ? user.email : "non connecté";
  $("btnLogin").style.display  = user ? "none":"inline-block";
  $("btnLogout").style.display = user ? "inline-block":"none";
  $("who").textContent = user ? user.email : "—";
}
async function onLogin(){
  const { data, error } = await supabase.auth.signInWithOAuth({
    provider:"google",
    options:{ redirectTo:location.origin+location.pathname, queryParams:{ prompt:"select_account" }, skipBrowserRedirect:true }
  });
  if(error) alert(error.message); else if(data?.url) location.href=data.url;
}
const onLogout = () => supabase.auth.signOut();

/* ---------- Realtime & load ---------- */
async function attachRealtime(){
  detachRealtime();
  sub = supabase.channel('devs')
    .on('postgres_changes',{event:'*',schema:'public',table:'devices'},loadDevices)
    .subscribe();
  tick = setInterval(loadDevices,15000);
}
function detachRealtime(){
  if(sub){ supabase.removeChannel(sub); sub=null; }
  if(tick){ clearInterval(tick); tick=null; }
}
async function loadDevices(){
  const { data, error } = await supabase
    .from('devices')
    .select('id,name,master_mac,last_seen,online')
    .order('created_at',{ascending:false});
  if(error){ log("Erreur chargement : "+error.message); return; }
  devices = data||[]; render();
}

/* ---------- Send / delete ---------- */
async function sendCommand(id, action, payload = {}){
  const { error } = await supabase
    .from("commands")
    .insert({ master_id: id, action, payload });        // ← master_id
  if(error) throw error;
  log(`[cmd] ${action} → ${id}`);
}
async function deleteDevice(id){
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session) return;
  const r = await fetch(`${SUPABASE_URL}/functions/v1/release_and_delete`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:`Bearer ${session.access_token}`,
      apikey:SUPABASE_ANON_KEY
    },
    body: JSON.stringify({ master_id: id })              // ← correct
  });
  if(!r.ok){
    log(`❌ Suppression refusée : ${await r.text()}`);
  }else{
    log(`MASTER supprimé : ${id}`);
  }
}

/* ---------- RENDER ---------- */
function render(){
  devicesEl.innerHTML = "";
  if(!devices.length){ devicesEl.textContent="Aucun MASTER."; return; }

  for(const d of devices){
    const live = isLive(d);
    const card = document.createElement("div");
    card.className = "card dev";
    card.innerHTML = `
      <div class="head">
        <div>${d.name||d.id}</div>
        <span class="badge ${live?'on':'off'}">${live?'En ligne':'Hors ligne'}</span>
      </div>
      <div class="meta">
        <div>ID : ${d.id}</div>
        <div>MAC : ${d.master_mac||'—'}</div>
        <div>Dernier contact : ${d.last_seen?new Date(d.last_seen).toLocaleTimeString():'jamais'}</div>
      </div>
      <div class="actions"></div>
    `;
    const actions = card.querySelector(".actions");
    const btn = (txt,cls,cb)=>{
      const b=document.createElement("button");
      b.textContent=txt;
      if(cls)b.className=cls;
      b.onclick=cb;
      actions.appendChild(b);
    };

    btn("Pulse 500 ms","",()=>sendCommand(d.id,"PULSE",{ms:500}).catch(e=>log(e.message)));
    btn("Power ON","",()=>sendCommand(d.id,"POWER_ON").catch(e=>log(e.message)));
    btn("Power OFF","",()=>sendCommand(d.id,"POWER_OFF").catch(e=>log(e.message)));
    btn("Reset","",()=>sendCommand(d.id,"RESET").catch(e=>log(e.message)));
    btn("Supprimer","danger",
        ()=>{ if(confirm(`Supprimer ${d.name||d.id} ?`)) deleteDevice(d.id); });

    devicesEl.append(card);
  }
}

/* ---------- Pair code ---------- */
async function onAdd(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ alert("Non connecté"); return; }
  const r = await fetch(`${SUPABASE_URL}/functions/v1/create_pair_code`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:`Bearer ${session.access_token}`,
      apikey:SUPABASE_ANON_KEY
    },
    body:JSON.stringify({ ttl_minutes:10 })
  });
  if(!r.ok){ alert(await r.text()); return; }
  const { code, expires_at } = await r.json();
  $("pairCode").textContent = pad6(code);
  const end = new Date(expires_at).getTime();
  const tick = ()=>{
    const left=Math.max(0,Math.floor((end-Date.now())/1000));
    $("pairExpires").textContent=`${Math.floor(left/60)}:${String(left%60).padStart(2,'0')}`;
  };
  tick(); setInterval(tick,1000);
  $("dlgPair").showModal();
}

/* ---------- Initial session ---------- */
supabase.auth.onAuthStateChange((evt,session)=>{
  if(evt==="INITIAL_SESSION"){
    updateAuthUI(session?.user ?? null);
    if(session?.user){ attachRealtime(); loadDevices(); }
  }
});

/* ---------- Boot log ---------- */
log("UI prête");
</script>
</body>
</html>
