<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Remote Power • MASTER</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
:root{--bg:#0f172a;--fg:#e2e8f0;--muted:#94a3b8;--card:#111827;--btn:#1f2937}
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);
          font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
header{display:flex;justify-content:space-between;align-items:center;
       padding:16px 20px;border-bottom:1px solid #243045}
h1{font-size:18px;margin:0}
.row{display:flex;gap:10px;align-items:center}
button{background:var(--btn);border:1px solid #2b364c;border-radius:8px;
       color:var(--fg);padding:8px 12px;cursor:pointer}
button:hover{filter:brightness(1.08)}
.primary{background:#2563eb;border-color:#1d4ed8}
.danger{background:#7f1d1d;border-color:#991b1b}
.muted{color:var(--muted)}
main{max-width:980px;margin:24px auto;padding:0 16px}
.card{background:var(--card);border:1px solid #243045;border-radius:12px;padding:14px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.dev{display:flex;flex-direction:column;gap:8px}
.head{display:flex;justify-content:space-between;gap:8px;align-items:center}
.badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #243045}
.on{background:#0b3b2e;color:#86efac;border-color:#14532d}
.off{background:#3b1a1a;color:#fecaca;border-color:#7f1d1d}
.meta,.slaves{font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:2px}
.actions{display:flex;flex-wrap:wrap;gap:6px}
.chip{display:inline-block;background:#334155;border-radius:999px;padding:2px 8px;margin:1px}
.log{white-space:pre-wrap;background:#0b1220;border:1px solid #243045;border-radius:10px;
     padding:10px;height:120px;overflow:auto}
dialog{border:1px solid #243045;border-radius:12px;background:var(--card);
       color:var(--fg);padding:0;max-width:420px}
dialog .dlg{padding:16px;display:flex;flex-direction:column;gap:10px}
code{background:#0b1220;border:1px solid #243045;border-radius:6px;padding:2px 6px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>

<body>
<header>
  <h1>Remote Power • MASTER</h1>
  <div class="row">
    <span id="userEmail" class="muted">non connecté</span>
    <button id="btnLogin"  class="primary" type="button" onclick="onLogin()">Connexion Google</button>
    <button id="btnLogout" type="button" style="display:none" onclick="onLogout()">Déconnexion</button>
  </div>
</header>

<main>
  <div class="row" style="justify-content:space-between;margin-bottom:12px">
    <div class="muted">Compte : <span id="who">—</span></div>
    <div class="row">
      <button id="btnAdd" class="primary" type="button" onclick="onAdd()">Ajouter un MASTER</button>
      <button id="btnRefresh" type="button" onclick="loadAll()">Rafraîchir</button>
    </div>
  </div>
  <div id="devices" class="grid"></div>
  <h3>Journal</h3><div id="log" class="log"></div>
</main>

<!-- Dialogue pair-code -->
<dialog id="dlgPair"><div class="dlg">
  <h3>Appairer un MASTER</h3>
  <div>Code : <code id="pairCode">······</code>
       (expire <span id="pairExpires" class="muted"></span>)</div>
  <div class="muted">Saisis ce code dans le portail Wi-Fi de l’ESP32.</div>
  <div class="row" style="justify-content:flex-end">
    <button onclick="dlgPair.close()">Fermer</button>
  </div>
</div></dialog>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL = "https://zeknluovgbsmtgupwkvo.supabase.co";
const SUPA_ANON    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpla25sdW92Z2JzbXRndXB3a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MjY2NjIsImV4cCI6MjA3NDMwMjY2Mn0.AjCTWEAGBBhi5liJv8LBCK_baqivRlDIYMbFcDeA_q4";   // <-- ta clé anon

/* ---------- INIT ---------- */
const sb = window.supabase.createClient(SUPABASE_URL, SUPA_ANON);
const $  = id => document.getElementById(id);
const log= txt=>{$('log').textContent+=new Date().toLocaleTimeString()+"  "+txt+"\n";};

/* ---------- Globals ---------- */
let devices=[], nodesByMaster={};  // nodes = slaves
let chanRealtime;

/* ---------- Helper ---------- */
const isLive=d=>d.last_seen&&Date.now()-new Date(d.last_seen).getTime()<25e3;

/* ---------- Auth ---------- */
function updateAuth(u){
  $("userEmail").textContent=u?u.email:"non connecté";
  $("btnLogin").style.display=u?"none":"inline-block";
  $("btnLogout").style.display=u?"inline-block":"none";
  $("who").textContent=u?u.email:"—";
}
async function onLogin(){
  const {data,error}=await sb.auth.signInWithOAuth({
    provider:"google",
    options:{redirectTo:location.href,queryParams:{prompt:"select_account"},skipBrowserRedirect:true}
  });
  if(error) alert(error.message); else if(data?.url) location.href=data.url;
}
function onLogout(){ sb.auth.signOut(); }

/* ---------- Load ALL (masters + slaves) ---------- */
async function loadAll(){
  const {data:devs,error:ed}=await sb.from('devices')
    .select('id,name,master_mac,last_seen,online')
    .order('created_at',{ascending:false});
  if(ed){log("Err devices: "+ed.message);return;}
  devices=devs||[];

  const {data:nodes,error:en}=await sb.from('nodes')   // table slaves si renommée
    .select('master_id,slave_mac');
  if(en){log("Err nodes: "+en.message);return;}
  nodesByMaster={};
  (nodes||[]).forEach(n=>{
    (nodesByMaster[n.master_id]??=[]).push(n.slave_mac);
  });

  render();
}

/* ---------- Commands & delete ---------- */
async function sendCmd(masterId,targetMac,action,payload={}){
  const {error}=await sb.from('commands').insert({
    master_id:masterId,
    target_mac: targetMac||null,
    action,
    payload
  });
  if(error) log("cmd err: "+error.message);
  else log(`[cmd] ${action} -> ${masterId}${targetMac?" → "+targetMac:""}`);
}
async function deleteDevice(id){
  const {data:{session}}=await sb.auth.getSession();
  if(!session){alert("Non connecté"); return;}
  const r=await fetch(`${SUPABASE_URL}/functions/v1/release_and_delete`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      apikey:SOPA_ANON,
      Authorization:`Bearer ${session.access_token}`
    },
    body:JSON.stringify({ master_id:id })
  });
  log(r.ok?`MASTER supprimé: ${id}`:`❌ Suppression: ${await r.text()}`);
}

/* ---------- Render ---------- */
function render(){
  const root=$("devices"); root.innerHTML="";
  if(!devices.length){root.textContent="Aucun MASTER.";return;}

  devices.forEach(d=>{
    const card=document.createElement("div"); card.className="card dev";
    const live=isLive(d);
    card.innerHTML=`
      <div class="head">
        <div>${d.name||d.id}</div>
        <span class="badge ${live?'on':'off'}">${live?'En ligne':'Hors ligne'}</span>
      </div>
      <div class="meta">
        ID : ${d.id}<br>MAC : ${d.master_mac||'—'}<br>
        Dernier contact : ${d.last_seen?new Date(d.last_seen).toLocaleTimeString():'jamais'}
      </div>`;
    /* slaves list */
    const slaves=(nodesByMaster[d.id]||[]);
    const sDiv=document.createElement("div"); sDiv.className="slaves";
    if(slaves.length){
      sDiv.textContent="Slaves : ";
      slaves.forEach(m=>{
        const c=document.createElement("span"); c.className="chip"; c.textContent=m;
        sDiv.appendChild(c);
      });
    }else sDiv.textContent="Aucun slave.";
    card.appendChild(sDiv);

    /* actions master */
    const act=document.createElement("div"); act.className="actions";
    const add=(t,cls,cb)=>{const b=document.createElement("button");
      b.textContent=t;if(cls)b.className=cls;b.onclick=cb;act.appendChild(b);}
    add("Pulse","",()=>sendCmd(d.id,null,"PULSE",{ms:500}));
    add("Power ON","",()=>sendCmd(d.id,null,"POWER_ON"));
    add("Power OFF","",()=>sendCmd(d.id,null,"POWER_OFF"));
    add("Reset","",()=>sendCmd(d.id,null,"RESET"));
    add("Supprimer","danger",()=>{if(confirm("Supprimer?")) deleteDevice(d.id);});
    card.appendChild(act);

    /* actions slaves */
    if(slaves.length){
      const a2=document.createElement("div"); a2.className="actions";
      slaves.forEach(mac=>{
        const on=document.createElement("button");on.textContent="LED ON";
        on.onclick=()=>sendCmd(d.id,mac,"LED",{on:true});
        const off=document.createElement("button");off.textContent="OFF";
        off.onclick=()=>sendCmd(d.id,mac,"LED",{on:false});
        a2.append(on,off);
      });
      card.appendChild(a2);
    }
    root.appendChild(card);
  });
}

/* ---------- Realtime ---------- */
function attachRealtime(){
  if(chanRealtime) sb.removeChannel(chanRealtime);
  chanRealtime=sb.channel("ui")
    .on('postgres_changes',{event:"*",schema:"public",table:"devices"},loadAll)
    .on('postgres_changes',{event:"*",schema:"public",table:"nodes"},  loadAll) // 'slaves' si renommé
    .subscribe(status=>{if(status==="SUBSCRIBED") log("Realtime ON");});
}

/* ---------- Pair-code ---------- */
async function onAdd(){
  const {data:{session}}=await sb.auth.getSession();
  if(!session){alert("Non connecté"); return;}

  try{
    const r=await fetch(`${SUPABASE_URL}/functions/v1/create_pair_code`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        apikey:SOPA_ANON,
        Authorization:`Bearer ${session.access_token}`
      },
      body:JSON.stringify({ ttl_minutes:10 })
    });
    if(!r.ok){alert(await r.text()); return;}
    const {code,expires_at}=await r.json();
    $("pairCode").textContent=String(code).padStart(6,"0");
    const end=new Date(expires_at).getTime();
    const tick=()=>{
      const left=Math.max(0,Math.floor((end-Date.now())/1000));
      $("pairExpires").textContent=
        `${Math.floor(left/60)}:${String(left%60).padStart(2,"0")}`;
      if(left<=0) clearInterval(id);
    };
    tick(); const id=setInterval(tick,1000);
    $("dlgPair").showModal();
    log(`Pair-code ${code} (expire ${new Date(expires_at).toLocaleTimeString()})`);
  }catch(e){ log("create_pair_code: "+e); alert("Erreur."); }
}

/* ---------- Boot ---------- */
sb.auth.onAuthStateChange((ev,session)=>{
  if(ev==="INITIAL_SESSION"){
    updateAuth(session?.user||null);
    if(session?.user){ attachRealtime(); loadAll(); }
  }
});
log("UI prête");
</script>
</body></html>
