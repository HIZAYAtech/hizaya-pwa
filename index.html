<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  />
  <title>Hizaya — Masters</title>
  <style>
    :root { --bg:#0b0d10; --card:#141820; --muted:#7a88a1; --text:#e9eef7; --ok:#1db954; --bad:#ff4d4f; --prim:#4a90e2; }
    html,body { margin:0; height:100%; background:var(--bg); color:var(--text); font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    a{color:var(--prim); text-decoration:none}
    .wrap { max-width:880px; margin:32px auto; padding:0 16px; }
    header { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .brand { font-weight:700; letter-spacing:.3px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .btn { padding:10px 14px; border-radius:10px; background:#1f2632; border:1px solid #2a3342; color:var(--text); cursor:pointer }
    .btn:hover{ filter:brightness(1.05) }
    .btn.prim{ background:var(--prim); border-color:var(--prim); color:#fff }
    .btn.bad{ background:#3a1c1d; border-color:#532528; color:#ffb8b8 }
    .btn.ghost{ background:transparent; border:1px dashed #2a3342 }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px; }
    .card { background:var(--card); border:1px solid #202633; border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:10px; }
    .title { font-weight:600; }
    .sub { color:var(--muted); font-size:12px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #2a3342; }
    .on { color:#bff0c7; background:#10351a; border-color:#1b5e20;}
    .off{ color:#ffd4d4; background:#3a1c1d; border-color:#5c2326;}
    .hint { color:var(--muted); margin:8px 0 16px }
    .hr { height:1px; background:#222a37; margin:10px 0 }
    .cmds { display:flex; flex-wrap:wrap; gap:8px }
    .empty { padding:20px; border:1px dashed #2a3342; border-radius:12px; color:var(--muted); text-align:center }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#1b2331; border:1px solid #2a3342; color:#b6c3da }
    .right { margin-left:auto }
    dialog { background:var(--card); color:var(--text); border:1px solid #2a3342; border-radius:16px; padding:0; width:min(420px,calc(100% - 32px)); }
    .dlg-head{ padding:14px 16px; border-bottom:1px solid #202633; display:flex; align-items:center; gap:10px; }
    .dlg-body{ padding:16px }
    .code { font:700 40px/1.1 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; letter-spacing:2px; }
    .dim { color:var(--muted) }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <div class="brand">Hizaya — Masters</div>
        <span id="me" class="pill"></span>
      </div>
      <div class="row">
        <button id="btnLogin" class="btn prim">Connexion Google</button>
        <button id="btnLogout" class="btn">Déconnexion</button>
      </div>
    </header>

    <div class="row" style="margin-bottom:10px">
      <button id="btnAdd" class="btn prim">Ajouter un master</button>
      <span id="status" class="pill">Préparation…</span>
      <span class="right dim mono" id="ts"></span>
    </div>

    <div id="devices" class="grid"></div>
    <div id="empty" class="empty" style="display:none">
      Aucun master pour ce compte. Utilise “Ajouter un master” pour générer un code d’appairage.
    </div>
  </div>

  <dialog id="dlg">
    <div class="dlg-head">
      <div style="font-weight:600">Appairage master</div>
      <button id="dlgClose" class="btn right">Fermer</button>
    </div>
    <div class="dlg-body">
      <div class="hint">Sur ton MASTER: ouvre le portail WiFi, connecte-toi au Wi-Fi de la maison, puis saisis ce code :</div>
      <div class="code" id="dlgCode">••••••</div>
      <div class="hr"></div>
      <div>Expire dans <span id="dlgLeft" class="mono">—</span></div>
    </div>
  </dialog>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPA_URL  = "https://zeknluovgbsmtgupwkvo.supabase.co";
    const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpla25sdW92Z2JzbXRndXB3a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MjY2NjIsImV4cCI6MjA3NDMwMjY2Mn0.AjCTWEAGBBhi5liJv8LBCK_baqivRlDIYMbFcDeA_q4";

    const supabase = createClient(SUPA_URL, SUPA_ANON);

    // UI refs
    const me     = document.getElementById("me");
    const status = document.getElementById("status");
    const ts     = document.getElementById("ts");
    const list   = document.getElementById("devices");
    const empty  = document.getElementById("empty");
    const dlg    = document.getElementById("dlg");
    const dlgClose = document.getElementById("dlgClose");
    const dlgCode  = document.getElementById("dlgCode");
    const dlgLeft  = document.getElementById("dlgLeft");

    const btnLogin  = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnAdd    = document.getElementById("btnAdd");

    let session = null;
    let realtimeSub = null;
    let pollTimer = null;
    let pairCountdownTimer = null;

    function nowTS(){
      const d = new Date();
      ts.textContent = d.toLocaleTimeString();
    }
    nowTS(); setInterval(nowTS, 1000);

    function fmtAgo(iso){
      if(!iso) return "—";
      const d = new Date(iso);
      const s = Math.floor((Date.now()-d.getTime())/1000);
      if (s < 60) return s+"s";
      const m = Math.floor(s/60); if(m<60) return m+"m";
      const h = Math.floor(m/60); if(h<24) return h+"h";
      const dd= Math.floor(h/24); return dd+"j";
    }

    function el(tag, cls, html){
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      if (html!=null) e.innerHTML = html;
      return e;
    }

    // ---------- AUTH ----------
    async function ensureSession() {
      const { data: { session: sess } } = await supabase.auth.getSession();
      session = sess;
      refreshAuthUI();
      return session;
    }

    function refreshAuthUI(){
      if (session?.user) {
        me.textContent = session.user.email || session.user.id;
        btnLogin.style.display = "none";
        btnLogout.style.display = "";
        btnAdd.disabled = false;
      } else {
        me.textContent = "Non connecté";
        btnLogin.style.display = "";
        btnLogout.style.display = "none";
        btnAdd.disabled = true;
      }
    }

    btnLogin.onclick = async () => {
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: location.href, queryParams: { prompt: "select_account" } }
      });
      if (error) alert("Erreur OAuth: " + error.message);
    };
    btnLogout.onclick = async () => {
      await supabase.auth.signOut();
      list.innerHTML = "";
      empty.style.display = "";
      status.textContent = "Déconnecté";
    };

    supabase.auth.onAuthStateChange((_evt, sess) => {
      session = sess;
      refreshAuthUI();
      if (session) { initData(); } else { teardownRealtime(); if (pollTimer) clearInterval(pollTimer); }
    });

    // ---------- DATA ----------
    async function loadDevices(){
      status.textContent = "Chargement...";
      const { data, error } = await supabase
        .from("devices")
        .select("id,name,master_mac,last_seen,online,created_at")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("devices select error:", error);
        status.textContent = "Erreur devices";
        return;
      }
      renderDevices(data);
      status.textContent = "OK";
    }

    function renderDevices(devs){
      list.innerHTML = "";
      if (!devs || devs.length === 0) {
        empty.style.display = "";
        return;
      }
      empty.style.display = "none";

      for (const d of devs) {
        const card = el("div","card");
        const head = el("div","row");
        head.append(
          el("div","title", (d.name ?? d.id)),
          el("span","badge " + (d.online ? "on":"off"), d.online ? "En ligne":"Hors ligne")
        );
        const sub = el("div","sub",
          `ID: <span class="mono">${d.id}</span><br>
           MAC: <span class="mono">${d.master_mac ?? "—"}</span><br>
           Dernier vu: ${d.last_seen ? new Date(d.last_seen).toLocaleString() : "—"} (${fmtAgo(d.last_seen)})`
        );

        const cmds = el("div","cmds");
        const bPulse = el("button","btn","PULSE");
        const bOn    = el("button","btn","POWER_ON");
        const bOff   = el("button","btn","POWER_OFF");
        const bRst   = el("button","btn","RESET");
        const bPair  = el("button","btn","START_PAIR");
        const bDel   = el("button","btn bad","Supprimer");

        bPulse.onclick = () => sendCmd(d.id,"PULSE",{ms:500});
        bOn.onclick    = () => sendCmd(d.id,"POWER_ON",{});
        bOff.onclick   = () => sendCmd(d.id,"POWER_OFF",{});
        bRst.onclick   = () => sendCmd(d.id,"RESET",{});
        bPair.onclick  = () => sendCmd(d.id,"START_PAIR",{seconds:120});
        bDel.onclick   = () => deleteDevice(d.id);

        cmds.append(bPulse,bOn,bOff,bRst,bPair,bDel);

        card.append(head, sub, el("div","hr"), cmds);
        list.append(card);
      }
    }

    async function sendCmd(device_id, action, payload){
      const { error } = await supabase
        .from("commands")
        .insert([{ device_id, action, payload }]);
      if (error) {
        alert("Commande refusée: " + (error.message || JSON.stringify(error)));
      } else {
        status.textContent = `Commande ${action} envoyée`;
      }
    }

    async function deleteDevice(device_id){
      if (!confirm(`Supprimer ${device_id} ?`)) return;
      const { error } = await supabase.from("devices").delete().eq("id", device_id);
      if (error) { alert("Suppression refusée: " + error.message); }
      else { status.textContent = "Supprimé"; await loadDevices(); }
    }

    // ---------- REALTIME + POLL ----------
    function teardownRealtime(){
      if (realtimeSub) { supabase.removeChannel(realtimeSub); realtimeSub=null; }
    }

    async function setupRealtime(){
      teardownRealtime();
      realtimeSub = supabase
        .channel("devices_changes")
        .on("postgres_changes",
          { event: "*", schema: "public", table: "devices" },
          (payload) => {
            // Un changement -> recharger rapidement
            loadDevices();
          }
        )
        .subscribe((status) => console.log("realtime:", status));
    }

    function setupPolling(){
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(loadDevices, 10000); // 10s
    }

    async function initData(){
      await loadDevices();
      await setupRealtime();
      setupPolling();
    }

    // ---------- PAIR CODE ----------
    function random6() { return String(Math.floor(100000 + Math.random()*900000)); }

async function createPairCode(){
  const { data, error } = await supabase.rpc("create_pair_code", { _minutes: 10 });
  if (error) throw error;
  // data est un array car RETURNS TABLE — prendre la première ligne
  const row = Array.isArray(data) ? data[0] : data;
  return { code: row.code, expires_at: row.expires_at };
}
      // Essayons un RPC standard si present
      let ok = false, respCode = code, respExp = expires_at;

      try {
        const { data, error } = await supabase.rpc("create_pair_code", {});
        if (!error && data && data.code) {
          respCode = data.code;
          // data.expires_at si renvoyée
          ok = true;
        }
      } catch(e){ /* ignore */ }

      if (!ok) {
        // Fallback: insert direct
const { error: e2 } = await supabase
  .from("pair_codes")
  .insert([{
    code,
    expires_at,
    owner_uid: session.user.id   // 👈 IMPORTANT
  }]);
if (e2) {
  alert("Impossible de créer le code: " + (e2.message || JSON.stringify(e2)));
  throw e2;
}
      }
      return { code: respCode, expires_at: respExp };
    }

    function openPairDialog(code, expiresISO){
      dlgCode.textContent = code;
      const end = new Date(expiresISO).getTime();
      function tick(){
        const left = Math.max(0, Math.floor((end - Date.now())/1000));
        const m = Math.floor(left/60), s = left%60;
        dlgLeft.textContent = `${m}m ${s.toString().padStart(2,'0')}s`;
        if (left<=0 && pairCountdownTimer){ clearInterval(pairCountdownTimer); pairCountdownTimer=null; }
      }
      if (pairCountdownTimer) clearInterval(pairCountdownTimer);
      tick();
      pairCountdownTimer = setInterval(tick, 1000);
      dlg.showModal();
    }

    btnAdd.onclick = async () => {
      if (!session) { alert("Connecte-toi d'abord."); return; }
      try {
        const { code, expires_at } = await createPairCode();
        openPairDialog(code, expires_at);
      } catch(e){}
    };
    dlgClose.onclick = () => dlg.close();

    // ---------- BOOT ----------
    (async () => {
      await ensureSession();
      if (session) { initData(); }
    })();
  </script>
</body>
</html>

