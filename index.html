<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HIZAYA â€¢ Remote Power</title>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root { --bg:#0b1220; --fg:#e6e9f0; --muted:#9aa3b2; --card:#121a2b; --accent:#3aa0ff; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #1c2742;position:sticky;top:0;background:var(--bg);z-index:2}
    .btn{padding:8px 12px;border:1px solid #2a3a60;background:#14203a;color:var(--fg);border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#001b2e;border:none}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    main{max-width:980px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1c2742;border-radius:16px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,select{background:#0f1627;border:1px solid #273456;color:var(--fg);padding:10px;border-radius:10px}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .log{font-family:ui-monospace,Menlo,monospace;font-size:13px;white-space:pre-wrap}
    .pill{padding:2px 8px;border-radius:999px;background:#1f2b47;border:1px solid #2f406a}
    .pill.warn{background:#3a2a2a;border-color:#6a2f2f}
    select#cmd-master{min-width:220px}
    #pairing-info{padding:8px 12px;border:1px solid #2a3a60;border-radius:10px}
  </style>
</head>
<body>
  <header>
    <strong>HIZAYA â€¢ Remote Power</strong>
    <div id="auth-area">
      <button class="btn" id="btn-login-google">Connexion Google</button>
      <button class="btn hidden" id="btn-logout">Se dÃ©connecter</button>
    </div>
  </header>

  <main>
    <section class="card" id="whoami" aria-live="polite">Non connectÃ©.</section>

    <section class="card hidden" id="pairing">
      <h3>Appairage (code 6 chiffres)</h3>
      <div class="row">
        <button class="btn primary" id="btn-gen-code">GÃ©nÃ©rer un code (10 min)</button>
        <div id="pairing-info" class="muted"></div>
      </div>
      <p class="muted">Sur lâ€™ESP32, entre ce code dans le portail Wi-Fi. Le MASTER sâ€™ajoutera automatiquement Ã  ton compte.</p>
    </section>

    <section class="card hidden" id="devices">
      <h3>Mes MASTERs</h3>
      <div id="device-list" style="margin-top:12px"></div>
    </section>

    <section class="card hidden" id="commands">
      <h3>Envoyer un ordre</h3>
      <div class="row">
        <select id="cmd-master"></select>
        <input id="cmd-peer" placeholder="Peer MAC (optionnel)" />
        <select id="cmd-action">
          <option>POWER_ON</option>
          <option>POWER_OFF</option>
          <option>PULSE</option>
          <option>RESET</option>
        </select>
        <input id="cmd-payload" placeholder='Payload JSON (ex: {"ms":500})' />
        <button class="btn primary" id="btn-send-cmd">Envoyer</button>
      </div>
      <p class="muted">Les ordres expirent par dÃ©faut au bout de 10 minutes.</p>
    </section>

    <section class="card">
      <h3>Journal</h3>
      <div id="log" class="log">(prÃªt)</div>
    </section>
  </main>

  <!-- Supabase (global) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ======= CONFIG =======
    const SUPABASE_URL = 'https://zeknluovgbsmtgupwkvo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpla25sdW92Z2JzbXRndXB3a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MjY2NjIsImV4cCI6MjA3NDMwMjY2Mn0.AjCTWEAGBBhi5liJv8LBCK_baqivRlDIYMbFcDeA_q4';
    const REDIRECT_URL = 'https://hizayatech.github.io/hizaya-pwa/';
    // =======================

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = (q) => document.querySelector(q);
    const log = (m) => { const el = $('#log'); el.textContent += '\n' + new Date().toLocaleTimeString() + '  ' + m; el.scrollTop = el.scrollHeight; };

    // ======= LIVE STATUS CONFIG =======
    const ONLINE_THRESHOLD_MS = 8000; // 8s: si last_seen < 8s => en ligne

    const state = { devices: [] }; // cache local

    function parseIso(s){ return s ? new Date(s) : null }
    function isOnlineFrom(d){ return d ? (Date.now() - d.getTime()) < ONLINE_THRESHOLD_MS : false }
    function fmtAgo(d){
      if(!d) return 'â€”'
      const ms = Date.now() - d.getTime()
      if (ms < 2000) return 'Ã  lâ€™instant'
      const s = Math.floor(ms/1000); if (s < 60) return `${s}s`
      const m = Math.floor(s/60);    if (m < 60) return `${m}m`
      const h = Math.floor(m/60);    return `${h}h`
    }

    const ui = {
      who: $('#whoami'),
      pairingCard: $('#pairing'),
      btnGenCode: $('#btn-gen-code'),
      pairingInfo: $('#pairing-info'),
      devicesCard: $('#devices'),
      commandsCard: $('#commands'),
      btnLoginGoogle: $('#btn-login-google'),
      btnLogout: $('#btn-logout'),
      deviceList: $('#device-list'),
      cmdMaster: $('#cmd-master'),
      cmdPeer: $('#cmd-peer'),
      cmdAction: $('#cmd-action'),
      cmdPayload: $('#cmd-payload'),
      btnSendCmd: $('#btn-send-cmd')
    };

    let currentUser = null;
    let devicesChannel = null;

    async function refreshSession() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error) log('[auth] ' + error.message);
      currentUser = user;

      if (user) {
        ui.who.innerHTML = `<div>ConnectÃ© en tant que <strong>${user.email}</strong><div class="muted">id: ${user.id}</div></div>`;
        ui.pairingCard.classList.remove('hidden');
        ui.devicesCard.classList.remove('hidden');
        ui.commandsCard.classList.remove('hidden');
        ui.btnLoginGoogle.classList.add('hidden');
        ui.btnLogout.classList.remove('hidden');
        await loadDevices();
        subscribeDevices();
      } else {
        ui.who.textContent = 'Non connectÃ©.';
        ui.pairingCard.classList.add('hidden');
        ui.devicesCard.classList.add('hidden');
        ui.commandsCard.classList.add('hidden');
        ui.btnLoginGoogle.classList.remove('hidden');
        ui.btnLogout.classList.add('hidden');
        if (devicesChannel) { supabase.removeChannel(devicesChannel); devicesChannel = null; }
      }
    }

    // Auth (redirection forcÃ©e)
    ui.btnLoginGoogle?.addEventListener('click', async () => {
      log('clic -> OAuthâ€¦');
      const { error, url } = await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: REDIRECT_URL } });
      if (error) { log('OAuth error: ' + error.message); return; }
      if (url) { log('redirect: ' + url); window.location.href = url; }
    });
    ui.btnLogout?.addEventListener('click', async () => {
      await supabase.auth.signOut(); log('DÃ©connectÃ©.'); refreshSession();
    });

    // GÃ©nÃ©ration code (UI)
    ui.btnGenCode?.addEventListener('click', async () => {
      const { data, error } = await supabase.rpc('create_pair_code', { ttl_minutes: 10 });
      if (error) { log('[pairing] ' + error.message); ui.pairingInfo.textContent = 'Erreur lors de la gÃ©nÃ©ration du code.'; return; }
      const code = data?.[0]?.code || data?.code || '(inconnu)';
      const exp  = data?.[0]?.expires_at || data?.expires_at || '';
      ui.pairingInfo.innerHTML = `
        <div>Code: <strong style="font-size:1.25rem;letter-spacing:2px">${code}</strong></div>
        <div class="muted">Expire Ã : ${exp ? new Date(exp).toLocaleString() : ''}</div>
        <div><button class="btn" id="btn-copy-code">Copier</button></div>`;
      document.querySelector('#btn-copy-code')?.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(code); log('Code copiÃ©.'); } catch {}
      });
      log(`Code d'appairage gÃ©nÃ©rÃ©: ${code} (expire ${exp})`);
    });

    // Charger devices -> maintient le cache + rendu
    async function loadDevices() {
      const { data, error } = await supabase
        .from('devices')
        .select('id,name,mac,last_seen,released_at,created_at')
        .order('created_at', { ascending: false });
      if (error) { log('[devices] ' + error.message); return; }

      state.devices = (data || []).map(d => ({ ...d, _lastSeenDate: parseIso(d.last_seen) }));
      renderDevices();
    }

    // Rendu de la liste + du select de commande
    function renderDevices() {
      // Select
      ui.cmdMaster.innerHTML = '';
      const ph = document.createElement('option');
      ph.value=''; ph.textContent='â€” Choisir un MASTER â€”'; ph.disabled=true; ph.selected=true;
      ui.cmdMaster.appendChild(ph);

      // Liste
      ui.deviceList.innerHTML = '';
      if (!state.devices.length) { log('Aucun MASTER trouvÃ©.'); return; }

      state.devices.forEach(d => {
        const row = document.createElement('div');
        row.className = 'card';
        row.dataset.id = d.id;

        const onlineLive = isOnlineFrom(d._lastSeenDate);
        const statusTxt = d.released_at
          ? `ðŸŸ¡ relÃ¢chÃ© le ${d.released_at ? new Date(d.released_at).toLocaleString() : ''}`
          : (onlineLive ? 'ðŸŸ¢ en ligne' : 'âšª hors ligne');

        row.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
            <div>
              <div><strong>${d.name || d.id}</strong> <span class="pill">${d.id}</span> ${d.released_at ? '<span class="pill warn">relÃ¢chÃ©</span>':''}</div>
              <div class="muted">
                <span data-online>${statusTxt}</span>
                Â· MAC: ${d.mac || 'â€”'} Â· last_seen: <span data-ago>${fmtAgo(d._lastSeenDate)}</span>
              </div>
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              <button class="btn" data-action="rename" data-id="${d.id}" data-name="${d.name||''}">Renommer</button>
              <button class="btn" data-action="peek" data-id="${d.id}">Voir peers</button>
              <button class="btn" data-action="delete" data-id="${d.id}" title="RelÃ¢cher puis supprimer">Supprimer</button>
            </div>
          </div>`;
        ui.deviceList.appendChild(row);

        if (!d.released_at) {
          const opt = document.createElement('option');
          opt.value = d.id; opt.textContent = d.name || d.id;
          ui.cmdMaster.appendChild(opt);
        }
      });
    }

    // Tick visuel: met Ã  jour "en ligne / hors ligne" + "ago" chaque seconde
    setInterval(() => {
      state.devices.forEach(d => {
        const card = ui.deviceList.querySelector(`.card[data-id="${d.id}"]`);
        if (!card) return;
        const onlineEl = card.querySelector('[data-online]');
        const agoEl = card.querySelector('[data-ago]');
        if (!onlineEl || !agoEl) return;
        const onlineLive = isOnlineFrom(d._lastSeenDate);
        onlineEl.textContent = d.released_at
          ? `ðŸŸ¡ relÃ¢chÃ© le ${d.released_at ? new Date(d.released_at).toLocaleString() : ''}`
          : (onlineLive ? 'ðŸŸ¢ en ligne' : 'âšª hors ligne');
        agoEl.textContent = fmtAgo(d._lastSeenDate);
      });
    }, 1000);

    // Realtime: maintient le cache sans refetch complet
    function subscribeDevices() {
      if (devicesChannel) return;
      devicesChannel = supabase
        .channel('devices-live')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'devices' }, async (payload) => {
          const ev = payload.eventType;
          const row = payload.new || payload.old;
          if (!row) return;

          if (ev === 'INSERT') {
            state.devices.unshift({ ...payload.new, _lastSeenDate: parseIso(payload.new.last_seen) });
            renderDevices();
            log(`Nouveau MASTER: ${payload.new.id}`);
          }
          if (ev === 'UPDATE') {
            const idx = state.devices.findIndex(x => x.id === payload.new.id);
            if (idx >= 0) {
              state.devices[idx] = { ...payload.new, _lastSeenDate: parseIso(payload.new.last_seen) };
              renderDevices();
            }
          }
          if (ev === 'DELETE') {
            state.devices = state.devices.filter(x => x.id !== payload.old.id);
            renderDevices();
            log(`SupprimÃ©: ${payload.old.id}`);
          }
        })
        .subscribe();
    }

    // Actions liste devices
    document.querySelector('#device-list')?.addEventListener('click', async (e) => {
      const btn = e.target.closest('button'); if (!btn) return;
      const id = btn.dataset.id;

      if (btn.dataset.action === 'peek') {
        const { data, error } = await supabase.from('peers').select('*').eq('master_id', id).order('name');
        if (error) { log('[peers] ' + error.message); return; }
        log(`Peers de ${id}: ` + (data.length ? data.map(p=>`${p.name}(${p.mac})`).join(', ') : 'aucun'));
      }

      if (btn.dataset.action === 'rename') {
        const current = btn.dataset.name || id;
        const next = prompt(`Nouveau nom pour ${id}:`, current);
        if (!next || next === current) return;
        const { error } = await supabase.from('devices').update({ name: next }).eq('id', id);
        if (error) log('[devices rename] ' + error.message); else { log(`RenommÃ© ${id} â†’ ${next}`); loadDevices(); }
      }

      if (btn.dataset.action === 'delete') {
        // Un seul bouton: RelÃ¢cher â†’ Supprimer automatiquement
        btn.disabled = true;
        const original = btn.textContent;
        btn.textContent = 'Suppression...';
        try {
          const { error: relErr } = await supabase.rpc('release_device', { _device_id: id });
          if (relErr) log(`[release before delete] ${relErr.message}`); else log(`RelÃ¢chÃ©: ${id}`);

          const { error: delErr } = await supabase.from('devices').delete().eq('id', id);
          if (delErr) { log(`[devices delete] ${delErr.message}`); }
          else { log(`SupprimÃ© ${id}`); /* le realtime fera le rendu */ }
        } finally {
          if (document.body.contains(btn)) { btn.disabled = false; btn.textContent = original; }
        }
      }
    });

    // Envoi d'ordre
    ui.btnSendCmd?.addEventListener('click', async () => {
      const master_id = ui.cmdMaster.value;
      if (!master_id) { log('Choisis un MASTER.'); return; }
      const peer_mac  = ui.cmdPeer.value.trim() || null;
      const action    = ui.cmdAction.value;
      let payload     = {};
      const raw       = ui.cmdPayload.value.trim();
      if (raw) { try { payload = JSON.parse(raw); } catch { log('Payload JSON invalide.'); return; } }
      const { error } = await supabase.from('commands').insert({ master_id, peer_mac, action, payload, created_by: currentUser.id });
      if (error) { log('[commands insert] ' + error.message); return; }
      log(`Ordre ${action} crÃ©Ã© pour ${master_id}${peer_mac? ' â†’ '+peer_mac:''}`);
    });

    // Boot
    supabase.auth.onAuthStateChange((_e,_s)=>{ refreshSession(); });
    refreshSession().catch(console.error);
  </script>
</body>
</html>
