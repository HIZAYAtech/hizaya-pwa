<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HIZAYA â€¢ Auth Test</title>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{--bg:#0b1220;--fg:#e6e9f0;--muted:#9aa3b2;--card:#121a2b;--accent:#3aa0ff}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:16px system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #1c2742}
    .btn{padding:8px 12px;border:1px solid #2a3a60;background:#14203a;color:var(--fg);border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#001b2e;border:none}
    main{max-width:760px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1c2742;border-radius:16px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,select{background:#0f1627;border:1px solid #273456;color:var(--fg);padding:10px;border-radius:10px}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .log{font-family:ui-monospace,Menlo,monospace;font-size:13px;white-space:pre-wrap}
    .pill{padding:2px 8px;border-radius:999px;background:#1f2b47;border:1px solid #2f406a}
    select#cmd-master { min-width: 220px; }
  </style>
</head>
<body>
  <header>
    <strong>HIZAYA â€¢ Auth Test</strong>
    <div id="auth-area">
      <button class="btn" id="btn-login-google">Connexion Google</button>
      <button class="btn hidden" id="btn-logout">Se dÃ©connecter</button>
    </div>
  </header>

  <main>
    <section class="card" id="whoami" aria-live="polite">Non connectÃ©.</section>

    <section class="card hidden" id="devices">
      <h3>Mes MASTERs</h3>
      <div class="row">
        <input id="new-device-id" placeholder="MASTER ID (ex: MASTER_001)" />
        <input id="new-device-key" placeholder="ClÃ© secrÃ¨te (garde-la pour l'ESP32)" />
        <input id="new-device-name" placeholder="Nom (optionnel)" />
        <button class="btn primary" id="btn-add-device">+ Ajouter</button>
      </div>
      <div id="device-list" style="margin-top:12px"></div>
    </section>

    <section class="card hidden" id="commands">
      <h3>Envoyer un ordre</h3>
      <div class="row">
        <select id="cmd-master"></select>
        <input id="cmd-peer" placeholder="Peer MAC (optionnel)" />
        <select id="cmd-action">
          <option>POWER_ON</option>
          <option>POWER_OFF</option>
          <option>PULSE</option>
          <option>RESET</option>
        </select>
        <input id="cmd-payload" placeholder='Payload JSON (ex: {"ms":500})' />
        <button class="btn primary" id="btn-send-cmd">Envoyer</button>
      </div>
      <p class="muted">Les ordres expirent aprÃ¨s 10 minutes par dÃ©faut.</p>
    </section>

    <section class="card">
      <h3>Journal</h3>
      <div id="log" class="log">(prÃªt)</div>
    </section>
  </main>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // ======= CONFIG Ã€ REMPLACER =======
    const SUPABASE_URL = 'https://zeknluovgbsmtgupwkvo.supabase.co'       // Settings â†’ API â†’ Project URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpla25sdW92Z2JzbXRndXB3a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MjY2NjIsImV4cCI6MjA3NDMwMjY2Mn0.AjCTWEAGBBhi5liJv8LBCK_baqivRlDIYMbFcDeA_q4'                       // Settings â†’ API â†’ anon public key
    const REDIRECT_URL = 'https://hizayatech.github.io/hizaya-pwa/' // ton GitHub Pages, avec le / final
    // ==================================

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const $ = (q) => document.querySelector(q)
    const log = (m) => { const el = $('#log'); el.textContent += `\n${new Date().toLocaleTimeString()}  ${m}`; el.scrollTop = el.scrollHeight }

    const ui = {
      who: $('#whoami'),
      devicesCard: $('#devices'),
      commandsCard: $('#commands'),
      btnLoginGoogle: $('#btn-login-google'),
      btnLogout: $('#btn-logout'),
      btnAddDevice: $('#btn-add-device'),
      deviceList: $('#device-list'),
      cmdMaster: $('#cmd-master'),
      cmdPeer: $('#cmd-peer'),
      cmdAction: $('#cmd-action'),
      cmdPayload: $('#cmd-payload'),
      btnSendCmd: $('#btn-send-cmd')
    }

    let currentUser = null

    async function refreshSession() {
      const { data: { user } } = await supabase.auth.getUser()
      currentUser = user
      if (user) {
        ui.who.innerHTML = `<div>ConnectÃ© en tant que <strong>${user.email}</strong><div class="muted">id: ${user.id}</div></div>`
        ui.devicesCard.classList.remove('hidden')
        ui.commandsCard.classList.remove('hidden')
        ui.btnLoginGoogle.classList.add('hidden')
        ui.btnLogout.classList.remove('hidden')
        await loadDevices()
      } else {
        ui.who.textContent = 'Non connectÃ©.'
        ui.devicesCard.classList.add('hidden')
        ui.commandsCard.classList.add('hidden')
        ui.btnLoginGoogle.classList.remove('hidden')
        ui.btnLogout.classList.add('hidden')
      }
    }

    ui.btnLoginGoogle?.addEventListener('click', async () => {
      log('Redirection Google OAuthâ€¦')
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: REDIRECT_URL }
      })
      if (error) log(`[auth] ${error.message}`)
    })

    ui.btnLogout?.addEventListener('click', async () => {
      await supabase.auth.signOut(); log('DÃ©connectÃ©.'); refreshSession()
    })

    async function loadDevices() {
  const { data, error } = await supabase
    .from('devices')
    .select('id,name,online,last_seen,created_at')
    .order('created_at', { ascending: false });

  if (error) { log(`[devices] ${error.message}`); return }

  // Reset UI
  ui.deviceList.innerHTML = ''
  ui.cmdMaster.innerHTML = ''

  // Placeholder dans le select
  const ph = document.createElement('option')
  ph.value = ''
  ph.textContent = 'â€” Choisir un MASTER â€”'
  ph.disabled = true
  ph.selected = true
  ui.cmdMaster.appendChild(ph)

  if (!data || data.length === 0) {
    log('Aucun MASTER trouvÃ©. Ajoute-en un dans la section Mes MASTERs.')
    return
  }

  // Remplir la liste + le select
  data.forEach(d => {
    // carte liste
    const row = document.createElement('div')
    row.className = 'card'
    row.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div>
          <div><strong>${d.name || d.id}</strong> <span class="pill">${d.id}</span></div>
          <div class="muted">${d.online ? 'ðŸŸ¢ en ligne' : 'âšª hors ligne'} Â· last_seen: ${d.last_seen || 'â€”'}</div>
        </div>
        <div style="display:flex;gap:6px;">
          <button class="btn" data-action="peek" data-id="${d.id}">Voir peers</button>
          <button class="btn" data-action="delete" data-id="${d.id}">Suppr</button>
        </div>
      </div>`
    ui.deviceList.appendChild(row)

    // option select
    const opt = document.createElement('option')
    opt.value = d.id
    opt.textContent = d.name || d.id
    ui.cmdMaster.appendChild(opt)
  })
}

    ui.btnAddDevice?.addEventListener('click', async () => {
      const id = $('#new-device-id').value.trim()
      const key = $('#new-device-key').value.trim()
      const name = $('#new-device-name').value.trim()
      if (!id || !key) { log('id + clÃ© requis.'); return }

      const { data, error } = await supabase.rpc('new_device', { _id: id, _key: key, _name: name || null })
      if (error) { log(`[new_device] ${error.message}`); return }
      log(`MASTER ajoutÃ©: ${data.id}`)
      $('#new-device-id').value = ''
      $('#new-device-key').value = ''
      $('#new-device-name').value = ''
      await loadDevices()
    })

    document.querySelector('#device-list')?.addEventListener('click', async (e) => {
      const btn = e.target.closest('button'); if (!btn) return
      const id = btn.dataset.id
      if (btn.dataset.action === 'delete') {
        if (!confirm(`Supprimer ${id} ?`)) return
        const { error } = await supabase.from('devices').delete().eq('id', id)
        if (error) log(`[devices delete] ${error.message}`); else { log(`SupprimÃ© ${id}`); loadDevices() }
      }
      if (btn.dataset.action === 'peek') {
        const { data, error } = await supabase.from('peers').select('*').eq('master_id', id).order('name')
        if (error) { log(`[peers] ${error.message}`); return }
        log(`Peers de ${id}: ` + (data.length ? data.map(p=>`${p.name}(${p.mac})`).join(', ') : 'aucun'))
      }
    })

    ui.btnSendCmd?.addEventListener('click', async () => {
      const master_id = $('#cmd-master').value
      const peer_mac  = $('#cmd-peer').value.trim() || null
      const action    = $('#cmd-action').value
      let payload     = {}
      const raw       = $('#cmd-payload').value.trim()
      if (raw) { try { payload = JSON.parse(raw) } catch { log('Payload JSON invalide.'); return } }

      const { error } = await supabase.from('commands').insert({ master_id, peer_mac, action, payload, created_by: currentUser.id })
      if (error) { log(`[commands insert] ${error.message}`); return }
      log(`Ordre ${action} crÃ©Ã© pour ${master_id}${peer_mac? ' â†’ '+peer_mac:''}`)
    })

    supabase.auth.onAuthStateChange((_e,_s)=>{ refreshSession() })
    refreshSession().catch(console.error)
  </script>
</body>
</html>

