<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <title>HIZAYA</title>
  <style>
    body{font-family:system-ui;margin:20px}
    input,button{padding:8px;margin:4px}
    table{border-collapse:collapse;margin-top:10px}
    td,th{border:1px solid #ccc;padding:6px 8px}
    #log{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;padding:10px;max-height:220px;overflow:auto}
  </style>
  <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt-min.js"></script>
</head>
<body>
  <h2>HIZAYA (PWA)</h2>

  <div>
    <label>Broker WSS:</label>
    <input id="host" value="broker.hivemq.com:8884/mqtt" size="28">
    <label>MASTER_ID:</label>
    <input id="mid" placeholder="A842E3917578" size="14">
    <button onclick="conn()">Connecter</button>
    <span id="st">offline</span>
  </div>

  <div>
    <button onclick="send({cmd:'ping'})">Ping</button>
    <button onclick="send({cmd:'get_peers'})">Peers</button>
    <button onclick="send({cmd:'scan_start'})">Scan</button>
    <button onclick="send({cmd:'get_scan'})">Découvertes</button>
  </div>

  <div>
    MAC: <input id="mac" size="20">
    <button onclick="send({cmd:'pair',mac:gid('mac').value})">Pairer</button>
    Nom: <input id="name" placeholder="Ordinateur 1">
    <button onclick="send({cmd:'rename',mac:gid('mac').value,name:gid('name').value})">Renommer</button>
  </div>

  <div>
    LED id: <input id="ledid" value="0" size="2"> MAC: <input id="mac2" size="20">
    <button onclick="send({cmd:'led',mac:gid('mac2').value,id:+gid('ledid').value,on:1})">ON</button>
    <button onclick="send({cmd:'led',mac:gid('mac2').value,id:+gid('ledid').value,on:0})">OFF</button>
  </div>

  <h3>Événements</h3>
  <div id="log"></div>
  <table id="tblPeers"><thead><tr><th>MAC</th><th>Nom</th></tr></thead><tbody></tbody></table>
  <table id="tblScan"><thead><tr><th>MAC</th><th>RSSI</th></tr></thead><tbody></tbody></table>

<script>
if ("serviceWorker" in navigator) navigator.serviceWorker.register("/hizaya-pwa/sw.js");

let client, TOP_CMD, TOP_EVT;
function gid(id){return document.getElementById(id)}
function log(s){ const d=gid('log'); d.textContent=(new Date()).toLocaleTimeString()+"  "+s+"\n"+d.textContent; }

function conn(){
  const host = gid('host').value.trim();  // ex: broker.hivemq.com:8884/mqtt
  const mid  = gid('mid').value.trim();
  if(!host || !mid){ alert("host + MASTER_ID requis"); return; }
  TOP_CMD = "hizaya/"+mid+"/cmd";
  TOP_EVT = "hizaya/"+mid+"/evt";

  const [h,p] = host.split('/');
  const parts = h.split(':'); const hostname=parts[0]; const port=+parts[1];

  client = new Paho.MQTT.Client(hostname, port, "/"+(p||"mqtt"), "web-"+Math.random().toString(16).slice(2));
  client.onConnectionLost = r=>{ gid('st').textContent='offline'; log("MQTT lost: "+r.errorMessage); };
  client.onMessageArrived = m=>{ handleEvt(m.payloadString); };

  client.connect({
    useSSL: true, timeout: 6,
    onSuccess: ()=>{ gid('st').textContent='online'; client.subscribe(TOP_EVT); log("Sub "+TOP_EVT); },
    onFailure: e=>{ gid('st').textContent='offline'; log("Fail: "+e.errorMessage); }
  });
}
function send(obj){
  if(!client || !client.isConnected()){ alert("MQTT non connecté"); return; }
  const m=new Paho.MQTT.Message(JSON.stringify(obj)); m.destinationName=TOP_CMD; client.send(m);
  log("→ "+JSON.stringify(obj));
}
function handleEvt(payload){
  log("← "+payload);
  try{
    const j=JSON.parse(payload);
    if(j.peers){
      const tb=document.querySelector('#tblPeers tbody'); tb.innerHTML='';
      j.peers.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.mac}</td><td>${p.name||''}</td>`; tb.appendChild(tr); });
    }
    if(j.scan){
      const tb=document.querySelector('#tblScan tbody'); tb.innerHTML='';
      j.scan.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.mac}</td><td>${p.rssi}</td>`; tb.appendChild(tr); });
    }
  }catch(e){}
}
</script>
</body>
</html>
